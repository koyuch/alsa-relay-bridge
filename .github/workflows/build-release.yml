name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-deb:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y debhelper dpkg-dev build-essential
        
    - name: Extract version from tag
      id: get_version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION=$(cat VERSION)
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
        
    - name: Update changelog with version
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        DATE=$(date -R)
        sed -i "1s/.*/alsa-relay-bridge ($VERSION) stable; urgency=medium/" debian/changelog
        sed -i "s/Sat, 28 Dec 2024 17:00:00 +0100/$DATE/" debian/changelog
        
    - name: Set executable permissions
      run: |
        chmod +x build-deb.sh install.sh uninstall.sh
        chmod +x debian/postinst debian/prerm debian/postrm debian/rules
        chmod +x relay_volume.py
        
    - name: Build Debian package
      run: |
        dpkg-buildpackage -us -uc -b
        
    - name: List built packages
      run: |
        ls -lh ../*.deb
        
    - name: Move packages to workspace
      run: |
        mkdir -p dist
        mv ../*.deb dist/
        mv ../*.buildinfo dist/ || true
        mv ../*.changes dist/ || true
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: debian-package
        path: dist/*.deb
        retention-days: 30
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*.deb
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
  lint-and-validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Install linting tools
      run: |
        pip install flake8 mypy
        
    - name: Lint Python code
      run: |
        flake8 relay_volume.py --max-line-length=100 --ignore=E501 || true
        
    - name: Type check with mypy
      run: |
        mypy relay_volume.py --ignore-missing-imports || true
        
    - name: Validate Debian package structure
      run: |
        sudo apt-get update
        sudo apt-get install -y lintian
        
    - name: Check shell scripts
      run: |
        sudo apt-get install -y shellcheck
        shellcheck build-deb.sh install.sh uninstall.sh || true
        shellcheck debian/postinst debian/prerm debian/postrm || true
